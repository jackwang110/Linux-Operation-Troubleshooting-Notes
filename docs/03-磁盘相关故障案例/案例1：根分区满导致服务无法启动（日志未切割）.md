# 案例1：根分区满导致服务无法启动（日志未切割）

## 故障现象

### 1. 告警信息

- 监控系统发出磁盘使用率超过 95% 的告警
- 告警级别：严重
- 告警时间：2026-01-22 06:00:00

### 2. 服务状态

- 系统服务无法启动
- 应用程序无法正常运行
- SSH 连接可能出现卡顿
- 系统日志无法写入

### 3. 系统表现

- `df -h` 显示根分区（/）使用率 100%
- 执行命令时出现 "No space left on device" 错误
- 无法创建新文件或目录
- 可能出现系统响应缓慢的情况

## 排查步骤

### 1. 查看磁盘使用情况

```bash
# 查看磁盘使用情况
$ df -h

# 查看磁盘使用详细信息
$ df -i

# 查看根分区的使用情况
$ du -sh /

# 查看根分区下各目录的使用情况
$ du -h --max-depth=1 / | sort -hr
```

### 2. 定位大文件和目录

```bash
# 查找根分区下大于 100MB 的文件
$ find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr

# 查找根分区下占用空间最大的目录
$ du -h --max-depth=2 / | sort -hr | head -20

# 查看日志目录的大小
$ du -sh /var/log/

# 查看 /var/log 下各文件的大小
$ ls -lh /var/log/
```

### 3. 分析日志文件

```bash
# 查看日志文件大小
$ ls -lh /var/log/*.log

# 查看日志文件的修改时间
$ ls -lht /var/log/

# 查看日志轮转配置
$ cat /etc/logrotate.conf

# 查看特定服务的日志轮转配置
$ cat /etc/logrotate.d/*

# 查看日志轮转状态
$ cat /var/lib/logrotate/status
```

### 4. 查看系统日志和应用日志

```bash
# 查看系统日志
$ tail -n 100 /var/log/syslog

# 查看内核日志
$ dmesg | tail -n 100

# 查看应用程序日志
$ tail -n 100 /var/log/application.log

# 查看日志轮转错误
$ grep -i error /var/log/syslog | grep logrotate
```

### 5. 检查服务状态

```bash
# 查看服务状态
$ systemctl status <service-name>

# 尝试启动服务
$ systemctl start <service-name>

# 查看服务启动失败的原因
$ journalctl -xe

# 查看服务日志
$ journalctl -u <service-name>
```

## 根因分析

### 1. 现象复述

根分区使用率达到 100%，导致系统服务无法启动，应用程序无法正常运行，执行命令时出现 "No space left on device" 错误。经排查，发现 /var/log 目录占用了大量空间，其中某些日志文件由于未正确轮转而变得非常大。

### 2. 根因假设

**假设 A：日志文件未切割**
- 现象：/var/log 目录占用大量空间，存在超大日志文件
- 机制解释：日志轮转配置不当或日志轮转服务未正常运行，导致日志文件持续增长，最终占满根分区
- 验证方法：查看日志文件大小，检查日志轮转配置和状态
- 影响范围：系统服务无法启动，应用程序无法正常运行
- 可能性：高

**假设 B：临时文件未清理**
- 现象：/tmp 或 /var/tmp 目录占用大量空间
- 机制解释：临时文件未及时清理，导致占用大量磁盘空间
- 验证方法：查看临时目录的大小和内容
- 影响范围：系统服务和应用程序可能受到影响
- 可能性：中

**假设 C：应用程序产生大量数据**
- 现象：应用程序数据目录占用大量空间
- 机制解释：应用程序产生了大量数据文件，未及时清理或归档
- 验证方法：查看应用程序数据目录的大小和内容
- 影响范围：特定应用程序可能无法正常运行
- 可能性：中

**假设 D：磁盘配额问题**
- 现象：特定用户或组的磁盘使用超过配额
- 机制解释：磁盘配额配置不当，导致特定用户或组的磁盘使用超过限制
- 验证方法：查看磁盘配额配置和使用情况
- 影响范围：特定用户或组的应用程序可能无法正常运行
- 可能性：低

### 3. 根因确认

通过查看磁盘使用情况和日志文件，确认了**假设 A** 是根本原因：
- /var/log 目录占用了根分区的大部分空间
- 存在多个超过 1GB 的日志文件，如 /var/log/syslog 和 /var/log/application.log
- 日志轮转配置存在问题，某些服务的日志未配置轮转
- 日志轮转服务可能未正常运行

## 解决方案

### 1. 紧急处理

1. **清理大日志文件**
   ```bash
   # 清空超大日志文件（注意：这会丢失日志数据）
   $ echo "" > /var/log/syslog
   $ echo "" > /var/log/application.log
   
   # 或压缩并归档旧日志
   $ gzip /var/log/syslog.1
   $ gzip /var/log/application.log.1
   ```

2. **清理临时文件**
   ```bash
   # 清理临时目录
   $ rm -rf /tmp/*
   $ rm -rf /var/tmp/*
   
   # 清理核心转储文件
   $ find / -name "core.*" -delete 2>/dev/null
   ```

3. **启动日志轮转**
   ```bash
   # 手动执行日志轮转
   $ logrotate -f /etc/logrotate.conf
   
   # 查看日志轮转状态
   $ cat /var/lib/logrotate/status
   ```

4. **启动服务**
   ```bash
   # 启动系统服务
   $ systemctl start <service-name>
   
   # 验证服务状态
   $ systemctl status <service-name>
   ```

### 2. 根本解决

1. **配置日志轮转**
   - **修改全局日志轮转配置**：
     ```bash
     # 编辑 /etc/logrotate.conf
     weekly
     rotate 4
     create
     dateext
     compress
     ```
   
   - **为特定服务配置日志轮转**：
     ```bash
     # 创建或编辑 /etc/logrotate.d/application
     /var/log/application.log {
       daily
       rotate 7
       compress
       delaycompress
       missingok
       notifempty
       create 644 root root
       postrotate
         systemctl reload application.service > /dev/null 2>&1 || true
       endscript
     }
     ```

2. **检查日志轮转服务**
   ```bash
   # 查看 logrotate 服务状态
   $ systemctl status logrotate
   
   # 启用并启动 logrotate 服务
   $ systemctl enable logrotate
   $ systemctl start logrotate
   
   # 检查 cron 服务状态（logrotate 通常通过 cron 执行）
   $ systemctl status cron
   ```

3. **调整分区大小**
   - 考虑将 /var 目录挂载到独立分区
   - 或扩展根分区的大小
   - 对于云服务器，可以调整磁盘大小

4. **监控和预警**
   - 设置磁盘使用率告警阈值（如 85%）
   - 监控日志文件大小
   - 定期检查日志轮转状态

### 3. 验证结果

- 根分区使用率恢复正常（低于 70%）
- 系统服务能够正常启动
- 应用程序能够正常运行
- 日志文件能够正常轮转
- 监控系统不再发出告警

## 预防措施

### 1. 技术措施

1. **日志管理**
   - 为所有服务配置合理的日志轮转策略
   - 定期检查日志轮转状态
   - 考虑使用集中式日志管理系统（如 ELK Stack）
   - 限制日志文件的大小和保留时间

2. **磁盘监控**
   - 设置磁盘使用率告警阈值（如 85%）
   - 监控磁盘使用趋势，及时发现异常增长
   - 监控 inode 使用情况，避免 inode 耗尽
   - 定期检查磁盘健康状态

3. **文件系统管理**
   - 合理规划分区，将 /var、/tmp 等目录挂载到独立分区
   - 为重要目录设置磁盘配额
   - 定期清理临时文件和不必要的文件
   - 考虑使用自动清理脚本

4. **服务配置**
   - 配置服务的日志级别，避免过多的 debug 日志
   - 为服务设置合理的日志文件大小限制
   - 启用日志压缩和归档
   - 考虑使用系统日志服务（如 rsyslog）集中管理日志

### 2. 流程措施

1. **定期维护**
   - 定期检查磁盘使用情况
   - 定期清理不必要的文件
   - 定期检查日志轮转配置和状态
   - 定期备份重要数据

2. **变更管理**
   - 对日志配置的变更进行测试和验证
   - 实施灰度发布，逐步扩大影响范围
   - 建立配置变更审批流程

3. **应急响应**
   - 制定磁盘空间不足的应急响应流程
   - 建立日志管理问题的应急预案
   - 定期演练磁盘故障的处理流程

### 3. 人员措施

1. **培训**
   - 对运维人员进行磁盘管理培训
   - 培训运维人员使用日志管理工具
   - 提高运维人员对磁盘空间问题的认识

2. **知识共享**
   - 建立磁盘管理知识库
   - 记录和分析历史磁盘故障案例
   - 分享日志管理最佳实践

## 参考命令

### 1. 磁盘使用查看

```bash
# 查看磁盘使用情况
df -h

# 查看 inode 使用情况
df -i

# 查看目录使用情况
du -h --max-depth=1 /

# 查找大文件
find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr
```

### 2. 日志管理

```bash
# 查看日志文件大小
ls -lh /var/log/*.log

# 手动执行日志轮转
logrotate -f /etc/logrotate.conf

# 查看日志轮转配置
cat /etc/logrotate.conf

# 查看特定服务的日志轮转配置
cat /etc/logrotate.d/*
```

### 3. 服务管理

```bash
# 查看服务状态
systemctl status <service-name>

# 启动服务
systemctl start <service-name>

# 查看服务日志
journalctl -u <service-name>

# 查看系统日志
journalctl -xe
```

### 4. 清理操作

```bash
# 清空文件
echo "" > /path/to/file

# 压缩文件
gzip /path/to/file

# 清理临时文件
rm -rf /tmp/*
rm -rf /var/tmp/*

# 清理核心转储文件
find / -name "core.*" -delete 2>/dev/null
```

## 总结

本案例中，根分区满导致服务无法启动的根本原因是日志文件未正确切割。由于日志轮转配置不当或日志轮转服务未正常运行，导致日志文件持续增长，最终占满根分区。

通过清理大日志文件、配置合理的日志轮转策略、检查日志轮转服务状态等措施，成功解决了故障。同时，通过建立磁盘监控机制、定期维护、合理规划分区等预防措施，避免类似故障再次发生。

此案例提醒我们，日志管理是系统运维的重要组成部分，需要配置合理的日志轮转策略，定期检查日志状态，避免因日志文件过大导致的磁盘空间问题。