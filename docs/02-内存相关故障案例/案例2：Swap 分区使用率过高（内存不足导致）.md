# 案例2：Swap 分区使用率过高（内存不足导致）

## 故障现象

### 1. 告警信息

- 监控系统发出 Swap 分区使用率超过 80% 的告警
- 告警级别：中度
- 告警时间：2026-01-19 08:30:00

### 2. 服务状态

- 系统响应缓慢
- 应用程序启动时间变长
- 进程切换时间增加
- 可能出现 OOM（Out of Memory）杀死进程的情况

### 3. 系统表现

- `free -h` 显示 Swap 分区使用接近 100%
- `top` 命令显示内存使用接近 100%
- 系统可能出现卡顿现象
- 磁盘 IO 可能增加（由于频繁的 Swap 操作）

## 排查步骤

### 1. 查看内存和 Swap 使用情况

```bash
# 查看内存和 Swap 使用情况
$ free -h

# 查看内存使用详细信息
$ cat /proc/meminfo

# 查看 Swap 使用详细信息
$ swapon -s

# 查看系统负载
$ uptime
```

### 2. 分析进程内存使用

```bash
# 查看进程内存使用排序
$ ps aux --sort=-%mem | head -10

# 查看进程的 Swap 使用情况
$ for pid in $(ps aux | awk '{print $2}'); do echo "PID: $pid, Swap: $(grep VmSwap /proc/$pid/status 2>/dev/null | awk '{print $2}') kB"; done | sort -k3 -nr | head -10

# 查看每个进程的内存使用详情
$ top -o %MEM
```

### 3. 分析系统内存管理

```bash
# 查看内存使用统计
$ vmstat 1

# 查看内存页面交换情况
$ sar -B 1

# 查看内存使用历史数据
$ sar -r

# 查看 Swap 使用历史数据
$ sar -S
```

### 4. 查看系统日志和应用日志

```bash
# 查看系统日志
$ tail -n 100 /var/log/syslog

# 查看内核日志
$ dmesg | tail -n 100

# 查看 OOM 相关日志
$ grep -i oom /var/log/syslog

# 查看应用日志
$ tail -n 100 /var/log/application.log
```

### 5. 分析内存使用趋势

```bash
# 实时监控内存和 Swap 使用情况
$ watch -n 1 free -h

# 监控进程内存使用变化
$ while true; do ps aux | grep <PID> | grep -v grep; sleep 1; done

# 查看系统内存压力
$ cat /proc/pressure/memory
```

## 根因分析

### 1. 现象复述

服务器 Swap 分区使用率突然飙升至 80% 以上，系统响应缓慢，应用程序启动时间变长。经排查，发现内存使用接近 100%，系统正在频繁使用 Swap 分区来弥补内存不足。

### 2. 根因假设

**假设 A：物理内存不足**
- 现象：内存使用接近 100%，Swap 使用率高
- 机制解释：系统物理内存不足以满足应用程序的需求，导致系统将部分内存数据交换到 Swap 分区
- 验证方法：查看内存使用情况，分析进程内存使用，评估服务器内存规格是否满足需求
- 影响范围：系统整体性能下降
- 可能性：高

**假设 B：内存泄漏**
- 现象：内存使用持续增长，Swap 使用率高
- 机制解释：应用程序存在内存泄漏，导致内存使用量持续增长，最终耗尽物理内存，系统开始使用 Swap
- 验证方法：分析进程内存使用趋势，使用内存泄漏检测工具
- 影响范围：单个进程内存使用过高，可能导致系统性能下降
- 可能性：中

**假设 C：内存密集型操作**
- 现象：内存使用突然增长，Swap 使用率高
- 机制解释：应用程序执行了内存密集型操作，如大数据处理、排序等，暂时需要大量内存
- 验证方法：查看应用程序日志，了解其执行的操作
- 影响范围：特定操作或功能导致内存使用高
- 可能性：中

**假设 D：Swap 配置不合理**
- 现象：Swap 使用率高，但内存使用不是很高
- 机制解释：Swap 分区大小配置不合理，或 vm.swappiness 参数设置不当
- 验证方法：查看 Swap 配置，检查 vm.swappiness 参数
- 影响范围：系统内存管理效率低
- 可能性：低

### 3. 根因确认

通过分析内存使用情况和进程内存使用，确认了**假设 A** 是根本原因：
- 物理内存使用接近 100%
- 多个进程占用了大量内存
- 服务器内存规格无法满足当前的业务负载
- 随着业务量的增长，内存需求超过了服务器的物理内存容量

## 解决方案

### 1. 紧急处理

1. **释放内存**
   ```bash
   # 清理系统缓存
   $ sync; echo 3 > /proc/sys/vm/drop_caches
   
   # 终止非必要的高内存进程
   $ kill -9 <PID>
   ```

2. **调整 Swap 使用策略**
   ```bash
   # 临时调整 vm.swappiness 参数，减少 Swap 使用
   $ sysctl vm.swappiness=10
   ```

3. **重启内存密集型服务**
   ```bash
   # 重启服务
   $ systemctl restart <service-name>
   ```

### 2. 根本解决

1. **增加物理内存**
   - 根据内存使用情况，评估需要增加的内存容量
   - 选择合适的内存模块，确保兼容性
   - 安装内存并验证

2. **优化应用程序**
   - 识别并优化内存密集型操作
   - 实现内存使用限制和监控
   - 使用缓存机制，减少内存使用
   - 考虑使用更高效的算法和数据结构

3. **调整系统配置**
   - **调整 Swap 大小**：
     ```bash
     # 创建新的 Swap 文件
     $ dd if=/dev/zero of=/swapfile bs=1G count=8
     $ chmod 600 /swapfile
     $ mkswap /swapfile
     $ swapon /swapfile
     
     # 将 Swap 文件添加到 /etc/fstab
     $ echo "/swapfile none swap sw 0 0" >> /etc/fstab
     ```
   - **调整内存管理参数**：
     ```bash
     # 调整 vm.swappiness 参数
     $ echo "vm.swappiness=60" >> /etc/sysctl.conf
     
     # 调整 vm.dirty_ratio 和 vm.dirty_background_ratio
     $ echo "vm.dirty_ratio = 10" >> /etc/sysctl.conf
     $ echo "vm.dirty_background_ratio = 5" >> /etc/sysctl.conf
     
     # 应用配置
     $ sysctl -p
     ```

4. **服务架构优化**
   - 考虑使用分布式架构，分散内存压力
   - 实现服务的水平扩展
   - 使用容器化技术，限制每个容器的内存使用
   - 考虑使用云服务，根据需求弹性扩展内存

### 3. 验证结果

- 内存使用率恢复正常（低于 70%）
- Swap 使用率恢复正常（低于 50%）
- 系统响应速度恢复正常
- 应用程序启动时间恢复正常
- 监控系统不再发出告警

## 预防措施

### 1. 技术措施

1. **内存监控**
   - 设置内存使用率告警阈值（如 85%）
   - 设置 Swap 使用率告警阈值（如 70%）
   - 监控内存使用趋势，及时发现内存增长
   - 监控进程内存使用，识别内存使用异常的进程

2. **容量规划**
   - 定期评估服务器内存使用情况
   - 根据业务增长预测，提前规划内存扩容
   - 建立内存容量基线，了解正常内存使用水平

3. **应用程序优化**
   - 实现内存使用限制和监控
   - 使用内存池、对象池等技术减少内存分配开销
   - 优化数据结构和算法，减少内存使用
   - 定期进行内存泄漏检测

4. **系统调优**
   - 根据系统类型和工作负载，调整内存管理参数
   - 合理配置 Swap 大小和使用策略
   - 优化文件系统缓存设置

### 2. 流程措施

1. **变更管理**
   - 对内存相关的变更进行评估和测试
   - 实施灰度发布，逐步扩大影响范围
   - 建立代码发布审批流程，确保代码质量

2. **定期维护**
   - 定期检查内存使用情况
   - 定期清理系统缓存
   - 定期优化应用程序内存使用

3. **应急响应**
   - 制定内存不足的应急响应流程
   - 建立 Swap 使用率过高的应急预案
   - 定期演练内存故障的处理流程

### 3. 人员措施

1. **培训**
   - 对开发人员进行内存管理培训
   - 培训开发人员使用内存分析工具
   - 提高开发人员对内存问题的认识

2. **知识共享**
   - 建立内存管理知识库
   - 记录和分析历史内存故障案例
   - 分享内存优化的经验和技巧

## 参考命令

### 1. 内存和 Swap 查看

```bash
# 查看内存和 Swap 使用情况
free -h

# 查看内存使用详细信息
cat /proc/meminfo

# 查看 Swap 使用详细信息
swapon -s

# 查看系统负载
uptime
```

### 2. 进程内存分析

```bash
# 查看进程内存使用排序
ps aux --sort=-%mem | head -10

# 查看进程的 Swap 使用情况
for pid in $(ps aux | awk '{print $2}'); do echo "PID: $pid, Swap: $(grep VmSwap /proc/$pid/status 2>/dev/null | awk '{print $2}') kB"; done | sort -k3 -nr | head -10

# 查看每个进程的内存使用详情
top -o %MEM
```

### 3. 系统内存管理

```bash
# 查看内存使用统计
vmstat 1

# 查看内存页面交换情况
sar -B 1

# 查看内存使用历史数据
sar -r

# 查看 Swap 使用历史数据
sar -S
```

### 4. 系统调优

```bash
# 调整 vm.swappiness 参数
sysctl vm.swappiness=60

# 清理系统缓存
sync; echo 3 > /proc/sys/vm/drop_caches

# 创建新的 Swap 文件
dd if=/dev/zero of=/swapfile bs=1G count=8
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
```

## 总结

本案例中，Swap 分区使用率过高的根本原因是物理内存不足。服务器内存容量无法满足当前的业务负载，导致系统将部分内存数据交换到 Swap 分区，从而影响系统性能。

通过释放内存、调整 Swap 使用策略、增加物理内存、优化应用程序等措施，成功解决了故障。同时，通过建立内存监控机制、进行容量规划、优化应用程序等预防措施，避免类似故障再次发生。

此案例提醒我们，在系统规划和运维过程中，需要充分考虑内存需求，确保服务器内存容量能够满足业务的增长需求，避免因内存不足导致的性能问题。