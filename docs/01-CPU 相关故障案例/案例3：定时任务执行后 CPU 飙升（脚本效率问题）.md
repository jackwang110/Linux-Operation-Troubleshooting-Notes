# 案例3：定时任务执行后 CPU 飙升（脚本效率问题）

## 故障现象

### 1. 告警信息

- 监控系统发出 CPU 使用率超过 90% 的告警
- 告警级别：中度
- 告警时间：2026-01-15 00:00:00（每天凌晨准时触发）

### 2. 服务状态

- 系统响应缓慢
- 其他服务性能下降
- 告警持续约 30 分钟后自动恢复

### 3. 系统表现

- `top` 命令显示多个 `bash` 进程占用大量 CPU 资源
- 这些进程都与定时任务相关
- 故障发生时间与定时任务执行时间一致

## 排查步骤

### 1. 查看定时任务配置

```bash
# 查看当前用户的定时任务
$ crontab -l

# 查看系统定时任务
$ ls -la /etc/cron.d/

# 查看定时任务执行日志
$ grep CRON /var/log/syslog | tail -n 100

# 查看系统定时任务配置
$ cat /etc/crontab
```

### 2. 查看定时任务执行的脚本

```bash
# 查看定时任务执行的脚本内容
$ cat /path/to/script.sh

# 查看脚本的执行权限
$ ls -la /path/to/script.sh

# 查看脚本的执行历史
$ history | grep script.sh
```

### 3. 分析脚本内容和执行过程

```bash
# 执行脚本并查看其执行过程
$ bash -x /path/to/script.sh

# 查看脚本执行时的系统资源使用情况
$ time /path/to/script.sh

# 查看脚本执行时的进程状态
$ ps aux | grep script.sh
```

### 4. 分析脚本中的问题

```bash
# 检查脚本中的循环结构
$ grep -n "for\|while\|until" /path/to/script.sh

# 检查脚本中的命令执行
$ grep -n "\|sort\|grep\|awk\|sed" /path/to/script.sh

# 检查脚本中的文件操作
$ grep -n "cat\|cp\|mv\|rm\|find" /path/to/script.sh
```

### 5. 查看系统日志和脚本输出

```bash
# 查看系统日志
$ tail -n 100 /var/log/syslog

# 查看脚本输出日志
$ tail -n 100 /var/log/script.log

# 查看脚本执行错误
$ tail -n 100 /var/log/error.log
```

## 根因分析

### 1. 现象复述

每天凌晨 00:00，服务器 CPU 使用率突然飙升至 90% 以上，系统响应缓慢，其他服务性能下降。告警持续约 30 分钟后自动恢复。经排查，发现多个 `bash` 进程占用大量 CPU 资源，这些进程都与定时任务相关。

### 2. 根因假设

**假设 A：脚本效率低下**
- 现象：定时任务执行后 CPU 飙升，持续时间较长
- 机制解释：脚本中存在低效的循环结构、大量的文件操作或复杂的命令组合，导致 CPU 使用率飙升
- 验证方法：分析脚本内容，执行脚本并监控其资源使用情况
- 影响范围：系统性能下降，其他服务受影响
- 可能性：高

**假设 B：脚本中存在死循环**
- 现象：CPU 使用率持续高，进程无法自动结束
- 机制解释：脚本中存在逻辑错误，导致循环无法正常退出
- 验证方法：分析脚本中的循环结构，检查循环条件
- 影响范围：系统资源耗尽，服务不可用
- 可能性：中

**假设 C：定时任务并发执行**
- 现象：多个相同的脚本进程同时执行
- 机制解释：定时任务配置不当，导致多个实例同时运行，竞争系统资源
- 验证方法：查看定时任务配置，检查是否存在重复执行的情况
- 影响范围：系统资源耗尽，服务不可用
- 可能性：中

### 3. 根因确认

通过分析脚本内容和执行过程，确认了**假设 A** 是根本原因：
- 脚本中存在多重嵌套循环，处理大量文件
- 使用了低效的命令组合，如在循环中频繁执行 `grep`、`sort` 等命令
- 没有合理使用缓存和临时文件，导致重复计算
- 脚本执行时间长，约 30 分钟才能完成

## 解决方案

### 1. 紧急处理

1. **临时调整定时任务执行时间**
   ```bash
   # 编辑定时任务
   $ crontab -e
   
   # 将执行时间从凌晨 00:00 改为凌晨 03:00（系统负载较低的时间）
   0 3 * * * /path/to/script.sh
   ```

2. **终止当前执行的脚本进程**
   ```bash
   # 查找脚本进程
   $ ps aux | grep script.sh
   
   # 终止进程
   $ kill -9 <PID>
   ```

### 2. 根本解决

1. **优化脚本效率**
   - **减少循环嵌套**：重构脚本，减少嵌套循环的层数
   - **使用更高效的命令**：用 `awk` 替代多个 `grep` 和 `sed` 组合
   - **合理使用缓存**：将中间结果存储在变量或临时文件中，避免重复计算
   - **批量处理**：将多个小文件合并处理，减少文件操作次数
   - **使用并行处理**：对于独立任务，使用 `parallel` 或 `xargs -P` 进行并行处理

2. **示例优化前后对比**

   **优化前**：
   ```bash
   # 低效的脚本示例
   for file in $(find /data -name "*.log"); do
     for line in $(cat $file); do
       if echo $line | grep "error"; then
         echo $line >> /tmp/errors.log
       fi
     done
   done
   sort /tmp/errors.log | uniq > /tmp/unique_errors.log
   ```

   **优化后**：
   ```bash
   # 高效的脚本示例
   find /data -name "*.log" -exec grep "error" {} \; | sort | uniq > /tmp/unique_errors.log
   ```

3. **使用更适合的工具**
   - 对于大数据处理，考虑使用 Python、Perl 等更高效的语言
   - 使用专门的日志分析工具，如 ELK Stack
   - 考虑使用数据库存储和查询数据，而不是文本文件

### 3. 验证结果

- 脚本执行时间从 30 分钟减少到 2 分钟
- CPU 使用率从 90% 以上降低到 30% 以下
- 系统响应速度恢复正常
- 其他服务性能不受影响
- 监控系统不再发出告警

## 预防措施

### 1. 技术措施

1. **脚本开发规范**
   - 制定脚本开发规范，包括效率要求
   - 对脚本进行代码审查，重点关注性能问题
   - 使用版本控制管理脚本，便于跟踪变更

2. **脚本测试**
   - 在测试环境中测试脚本的执行时间和资源使用情况
   - 对脚本进行压力测试，确保在大数据量下仍能正常运行
   - 监控脚本的执行状态，及时发现异常

3. **定时任务管理**
   - 合理安排定时任务的执行时间，避开系统负载高峰期
   - 为定时任务设置执行超时时间，避免无限执行
   - 监控定时任务的执行状态，及时发现失败的任务

### 2. 流程措施

1. **变更管理**
   - 对脚本的变更进行审批和测试
   - 记录脚本的变更历史，便于回滚
   - 定期审查定时任务配置，确保其合理性

2. **监控和告警**
   - 为定时任务执行设置监控和告警
   - 监控脚本的执行时间和资源使用情况
   - 对异常的定时任务执行进行告警

3. **定期维护**
   - 定期清理和归档日志文件，减少脚本处理的数据量
   - 定期优化脚本，提高其执行效率
   - 定期审查定时任务，移除不必要的任务

### 3. 人员措施

1. **培训**
   - 对脚本开发人员进行性能优化培训
   - 培训开发人员使用更高效的命令和工具
   - 提高开发人员对系统资源使用的认识

2. **知识共享**
   - 建立脚本库，共享高效的脚本示例
   - 分享脚本优化的经验和技巧
   - 记录和分析历史脚本性能问题

## 参考命令

### 1. 定时任务管理

```bash
# 查看当前用户的定时任务
crontab -l

# 编辑定时任务
crontab -e

# 查看系统定时任务
ls -la /etc/cron.d/

# 查看定时任务执行日志
grep CRON /var/log/syslog
```

### 2. 脚本分析和优化

```bash
# 执行脚本并查看其执行过程
bash -x /path/to/script.sh

# 查看脚本执行时的系统资源使用情况
time /path/to/script.sh

# 检查脚本中的循环结构
grep -n "for\|while\|until" /path/to/script.sh

# 检查脚本中的命令执行
grep -n "\|sort\|grep\|awk\|sed" /path/to/script.sh
```

### 3. 系统资源监控

```bash
# 查看系统负载
uptime

# 查看 CPU 使用率
top

# 查看进程状态
ps aux | grep script.sh

# 查看系统资源使用情况
vmstat 1
```

## 总结

本案例中，定时任务执行后 CPU 飙升的根本原因是脚本效率低下。脚本中存在多重嵌套循环、低效的命令组合和不合理的文件操作，导致 CPU 使用率飙升，执行时间长。

通过优化脚本效率、调整定时任务执行时间等措施，成功解决了故障。同时，通过制定脚本开发规范、加强脚本测试和定时任务管理等预防措施，避免类似故障再次发生。

此案例提醒我们，在编写和使用定时任务脚本时，需要关注其执行效率和资源使用情况，避免因脚本问题导致系统性能下降。