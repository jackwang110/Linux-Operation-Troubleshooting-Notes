# 案例2：CPU 负载高但使用率低（IO 等待导致）

## 故障现象

### 1. 告警信息

- 监控系统发出系统负载过高的告警
- 告警级别：中度
- 告警时间：2026-01-12 09:15:00

### 2. 服务状态

- 系统响应缓慢
- 命令执行延迟
- 应用程序启动时间变长

### 3. 系统表现

- `top` 命令显示负载平均值高（load average: 8.00, 7.50, 7.00）
- 但 CPU 使用率较低（%CPU: 10.0 us, 2.0 sy, 85.0 wa）
- IO 等待时间占比很高（wa: 85.0%）

## 排查步骤

### 1. 查看系统负载和 CPU 使用情况

```bash
# 查看系统负载
$ uptime

# 查看 CPU 使用率和 IO 等待
$ top

# 查看每个 CPU 核心的详细使用情况
$ mpstat -P ALL 1

# 查看虚拟内存统计，包括 IO 等待
$ vmstat 1
```

### 2. 分析 IO 性能

```bash
# 查看磁盘 IO 统计
$ iostat -x 1

# 查看进程 IO 使用情况
$ iotop

# 查看磁盘使用情况
$ df -h

# 查看磁盘分区和挂载点
$ lsblk -f
```

### 3. 定位高 IO 进程

```bash
# 查看进程 IO 使用排序
$ iotop -oP

# 查看进程打开的文件
$ lsof -p <PID>

# 查看进程当前工作目录
$ pwdx <PID>
```

### 4. 查看文件系统和磁盘状态

```bash
# 检查文件系统状态
$ fsck -n /dev/sda1

# 查看磁盘 SMART 信息
$ smartctl -a /dev/sda

# 查看磁盘分区信息
$ fdisk -l
```

### 5. 查看应用日志和系统日志

```bash
# 查看系统日志
$ tail -n 100 /var/log/syslog

# 查看内核日志
$ dmesg | tail -n 100

# 查看应用日志
$ tail -n 100 /var/log/application.log
```

## 根因分析

### 1. 现象复述

服务器负载平均值很高（8.00），但 CPU 使用率较低，IO 等待时间占比很高（85%）。系统响应缓慢，命令执行延迟，应用程序启动时间变长。经排查，发现大量进程在等待 IO 操作完成。

### 2. 根因假设

**假设 A：磁盘 IO 性能瓶颈**
- 现象：IO 等待时间高，磁盘 IO 使用率高
- 机制解释：磁盘读写速度无法满足应用程序的需求，导致进程在等待 IO 操作完成时阻塞，进而导致系统负载升高
- 验证方法：查看 iostat 输出，检查磁盘 IO 使用率和响应时间；使用 iotop 查看高 IO 进程
- 影响范围：整个系统性能下降
- 可能性：高

**假设 B：文件系统问题**
- 现象：IO 等待时间高
- 机制解释：文件系统损坏、挂载参数不当或文件系统类型不适合当前 workload
- 验证方法：检查文件系统状态，查看挂载参数，测试文件系统性能
- 影响范围：特定文件系统性能下降
- 可能性：中

**假设 C：磁盘硬件故障**
- 现象：IO 等待时间高，可能伴有错误日志
- 机制解释：磁盘物理损坏、接口故障或其他硬件问题导致 IO 操作延迟
- 验证方法：查看 SMART 信息，检查系统日志中的磁盘错误
- 影响范围：整个系统性能下降，可能导致数据丢失
- 可能性：中

### 3. 根因确认

通过查看 iostat 输出和系统日志，确认了**假设 A** 是根本原因：
- iostat 显示磁盘 sda 的 IO 使用率接近 100%（%util: 98.5%）
- 平均响应时间很高（avgqu-sz: 10.5, await: 50.2ms）
- iotop 显示多个数据库进程和备份进程在进行大量磁盘读写操作
- 系统日志中没有磁盘错误信息，排除了硬件故障的可能

## 解决方案

### 1. 紧急处理

1. **终止非必要的高 IO 进程**
   ```bash
   # 查看高 IO 进程
   $ iotop -oP
   
   # 终止非必要的进程
   $ kill -9 <PID>
   ```

2. **临时调整应用程序行为**
   - 暂停备份任务
   - 减少数据库查询频率
   - 限制应用程序的并发数

### 2. 根本解决

1. **优化磁盘 IO 性能**
   - **使用 SSD**：替换机械硬盘为 SSD，提高 IO 性能
   - **RAID 配置**：使用 RAID 0 或 RAID 10 提高读写性能
   - **分区优化**：将不同类型的数据存储在不同分区
   - **文件系统优化**：选择适合的文件系统（如 ext4、xfs），调整挂载参数

2. **优化应用程序**
   - **数据库优化**：
     - 调整数据库缓存大小
     - 优化 SQL 查询
     - 使用索引减少全表扫描
     - 定期清理和优化数据库
   - **应用程序优化**：
     - 实现缓存机制，减少磁盘 IO
     - 批量处理数据，减少 IO 次数
     - 使用异步 IO 操作

3. **系统配置优化**
   - **调整 IO 调度器**：
     ```bash
     # 查看当前 IO 调度器
     $ cat /sys/block/sda/queue/scheduler
     
     # 设置 IO 调度器为 deadline（适合数据库）
     $ echo deadline > /sys/block/sda/queue/scheduler
     ```
   - **调整系统参数**：
     ```bash
     # 调整 vm.dirty_ratio 和 vm.dirty_background_ratio
     $ echo "vm.dirty_ratio = 10" >> /etc/sysctl.conf
     $ echo "vm.dirty_background_ratio = 5" >> /etc/sysctl.conf
     $ sysctl -p
     ```

### 3. 验证结果

- 系统负载恢复正常（load average: 1.00, 1.20, 1.10）
- CPU 使用率分布正常（%CPU: 60.0 us, 10.0 sy, 5.0 wa）
- IO 等待时间占比降低（wa: 5.0%）
- 系统响应速度恢复正常
- 应用程序启动时间恢复正常

## 预防措施

### 1. 技术措施

1. **监控优化**
   - 添加磁盘 IO 性能监控
   - 设置 IO 等待时间告警阈值
   - 监控磁盘使用率和响应时间
   - 建立磁盘性能基准，及时发现异常

2. **存储架构优化**
   - 根据数据类型选择合适的存储介质
   - 实现分层存储，热数据存储在 SSD，冷数据存储在 HDD
   - 考虑使用分布式存储系统
   - 定期进行存储性能测试

3. **应用程序优化**
   - 实现缓存机制，减少磁盘 IO
   - 优化数据访问模式，减少随机 IO
   - 使用批量处理，减少 IO 次数
   - 定期清理临时文件和日志文件

### 2. 流程措施

1. **变更管理**
   - 对存储相关的变更进行评估和测试
   - 实施存储容量规划，避免磁盘空间不足
   - 建立存储设备生命周期管理

2. **定期维护**
   - 定期检查磁盘健康状态
   - 定期清理磁盘空间
   - 定期优化文件系统
   - 定期备份重要数据

3. **应急响应**
   - 制定 IO 性能问题的应急响应流程
   - 建立存储故障的应急预案
   - 定期演练存储故障的处理流程

### 3. 人员措施

1. **培训**
   - 对开发人员进行 IO 性能优化培训
   - 对运维人员进行存储管理和故障排查培训
   - 提高团队对存储性能问题的认识

2. **知识共享**
   - 建立存储性能优化知识库
   - 记录和分析历史存储故障案例
   - 分享存储管理最佳实践

## 参考命令

### 1. 系统状态查看

```bash
# 查看系统负载
uptime

# 查看 CPU 使用率和 IO 等待
top

# 查看每个 CPU 核心的详细使用情况
mpstat -P ALL 1

# 查看虚拟内存统计
vmstat 1
```

### 2. 磁盘 IO 分析

```bash
# 查看磁盘 IO 统计
iostat -x 1

# 查看进程 IO 使用情况
iotop

# 查看磁盘使用情况
df -h

# 查看磁盘分区和挂载点
lsblk -f
```

### 3. 磁盘管理

```bash
# 检查文件系统状态
fsck -n /dev/sda1

# 查看磁盘 SMART 信息
smartctl -a /dev/sda

# 调整 IO 调度器
echo deadline > /sys/block/sda/queue/scheduler
```

### 4. 系统优化

```bash
# 调整系统参数
echo "vm.dirty_ratio = 10" >> /etc/sysctl.conf
echo "vm.dirty_background_ratio = 5" >> /etc/sysctl.conf
sysctl -p

# 查看当前 IO 调度器
cat /sys/block/sda/queue/scheduler
```

## 总结

本案例中，服务器负载高但 CPU 使用率低的根本原因是 IO 等待时间过长。这通常是由于磁盘 IO 性能无法满足应用程序的需求，导致进程在等待 IO 操作完成时阻塞，进而导致系统负载升高。

通过终止非必要的高 IO 进程、优化磁盘 IO 性能、优化应用程序和系统配置等措施，成功解决了故障。同时，通过添加磁盘 IO 性能监控、优化存储架构、定期维护等预防措施，避免类似故障再次发生。

此案例提醒我们，系统负载高并不总是由 CPU 使用率高引起的，IO 等待也是导致系统负载升高的重要原因。在排查系统性能问题时，需要综合考虑 CPU、内存、磁盘 IO 等多个方面的因素。