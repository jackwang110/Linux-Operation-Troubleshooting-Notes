# 案例1：生产服务器 CPU 100% 告警（进程占用过高）

## 故障现象

### 1. 告警信息

- 监控系统发出 CPU 使用率超过 95% 的告警
- 告警级别：严重
- 告警时间：2026-01-10 14:30:00

### 2. 服务状态

- Web 应用响应缓慢
- API 接口超时
- 用户无法正常访问网站

### 3. 系统表现

- SSH 连接服务器卡顿
- 执行命令响应延迟
- 系统负载升高

## 排查步骤

### 1. 登录服务器查看 CPU 使用情况

```bash
# 登录服务器
$ ssh user@server-ip

# 查看 CPU 使用率
$ top

# 查看进程 CPU 使用排序
$ top -c

# 查看进程详细信息
$ ps aux --sort=-%cpu | head -10
```

### 2. 定位高 CPU 进程

**执行结果**：
```
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
www-data  1234 99.9  2.1 123456 45678 ?        R    14:25   5:30 php-fpm: pool www
www-data  1235 99.8  2.0 123456 45678 ?        R    14:25   5:29 php-fpm: pool www
www-data  1236 99.7  2.1 123456 45678 ?        R    14:25   5:28 php-fpm: pool www
```

**分析**：多个 php-fpm 进程占用了大量 CPU 资源，使用率接近 100%。

### 3. 查看进程详情和调用栈

```bash
# 查看进程打开的文件
$ lsof -p 1234

# 查看进程调用栈
$ pstack 1234

# 查看进程的系统调用
$ strace -p 1234
```

### 4. 查看应用日志

```bash
# 查看 PHP 错误日志
$ tail -n 100 /var/log/php-fpm/error.log

# 查看 Nginx 访问日志，寻找异常请求
$ tail -n 100 /var/log/nginx/access.log
```

### 5. 分析请求内容

**执行结果**：
```
192.168.1.100 - - [10/Jan/2026:14:25:00 +0800] "GET /api/v1/data?type=all&limit=100000 HTTP/1.1" 200 12345678 "-" "Mozilla/5.0"
192.168.1.100 - - [10/Jan/2026:14:25:01 +0800] "GET /api/v1/data?type=all&limit=100000 HTTP/1.1" 200 12345678 "-" "Mozilla/5.0"
192.168.1.100 - - [10/Jan/2026:14:25:02 +0800] "GET /api/v1/data?type=all&limit=100000 HTTP/1.1" 200 12345678 "-" "Mozilla/5.0"
```

**分析**：发现大量相同的 API 请求，参数 `limit=100000` 表示查询大量数据。

### 6. 查看数据库状态

```bash
# 查看 MySQL 进程列表
$ mysql -u root -p -e "show processlist;"

# 查看当前执行的 SQL 语句
$ mysql -u root -p -e "show full processlist;"
```

## 根因分析

### 1. 现象复述

生产服务器 CPU 使用率突然飙升至 100%，导致 Web 应用响应缓慢，用户无法正常访问。经排查，发现多个 php-fpm 进程占用了大量 CPU 资源，这些进程正在处理大量数据查询请求。

### 2. 根因假设

**假设 A：异常请求导致的资源耗尽**
- 现象：多个相同的 API 请求，查询大量数据
- 机制解释：客户端发起了大量包含 `limit=100000` 参数的请求，导致 PHP 进程需要处理大量数据，消耗大量 CPU 资源
- 验证方法：查看访问日志，确认请求来源和频率；查看数据库执行的 SQL 语句
- 影响范围：Web 服务不可用
- 可能性：高

**假设 B：代码逻辑问题**
- 现象：PHP 进程 CPU 使用率高
- 机制解释：代码中存在死循环、递归调用或其他导致 CPU 密集的逻辑
- 验证方法：查看代码，分析进程调用栈
- 影响范围：特定功能不可用
- 可能性：中

**假设 C：服务器资源不足**
- 现象：CPU 使用率高
- 机制解释：服务器 CPU 核心数不足，无法应对正常的业务负载
- 验证方法：分析历史负载数据，评估服务器规格是否满足需求
- 影响范围：整体服务性能下降
- 可能性：低

### 3. 根因确认

通过查看访问日志和数据库进程列表，确认了**假设 A** 是根本原因：
- 访问日志显示来自同一 IP 的大量相同请求
- 数据库进程列表显示大量执行时间长的 SQL 查询
- 这些查询都是针对同一个 API 端点，带有 `limit=100000` 参数

## 解决方案

### 1. 紧急处理

1. **临时限制请求**
   ```bash
   # 使用 iptables 限制来源 IP
   $ iptables -A INPUT -s 192.168.1.100 -j DROP
   
   # 重启 php-fpm 服务
   $ systemctl restart php-fpm
   ```

2. **清理异常进程**
   ```bash
   # 终止所有 php-fpm 进程
   $ pkill -f php-fpm
   
   # 启动 php-fpm 服务
   $ systemctl start php-fpm
   ```

### 2. 根本解决

1. **优化 API 接口**
   - 添加请求参数验证，限制 `limit` 参数的最大值（如 1000）
   - 实现分页机制，强制客户端使用分页查询
   - 添加请求频率限制，防止恶意请求

2. **优化数据库查询**
   - 为查询的字段添加索引
   - 优化 SQL 语句，避免全表扫描
   - 考虑使用缓存，减少数据库查询

3. **配置优化**
   - 调整 php-fpm 配置，限制单个进程的内存使用
   - 调整连接池大小，避免过多进程竞争资源
   - 启用慢查询日志，及时发现和优化慢查询

### 3. 验证结果

- CPU 使用率恢复正常（低于 30%）
- Web 应用响应速度恢复正常
- API 接口可以正常访问
- 监控系统不再发出告警

## 预防措施

### 1. 技术措施

1. **添加请求限制**
   - 实现 API 速率限制（Rate Limiting）
   - 对请求参数进行严格验证和限制
   - 使用 WAF（Web 应用防火墙）过滤异常请求

2. **优化监控**
   - 设置更精细的 CPU 使用率告警阈值
   - 添加进程级别的监控，及时发现异常进程
   - 监控慢查询，及时发现数据库性能问题

3. **代码优化**
   - 定期代码审查，发现并修复性能问题
   - 使用性能分析工具，识别 CPU 密集型代码
   - 实现优雅降级机制，在资源不足时保证核心功能可用

### 2. 流程措施

1. **变更管理**
   - 新 API 上线前进行性能测试
   - 实施灰度发布，逐步扩大影响范围
   - 建立代码发布审批流程，确保代码质量

2. **应急响应**
   - 制定 CPU 使用率异常的应急响应流程
   - 定期演练应急响应流程，提高处理速度
   - 建立故障复盘机制，总结经验教训

### 3. 人员措施

1. **培训**
   - 对开发人员进行性能优化培训
   - 对运维人员进行故障排查培训
   - 提高团队的应急响应能力

2. **知识共享**
   - 建立性能问题知识库
   - 定期分享性能优化经验
   - 记录和分析历史故障案例

## 参考命令

### 1. CPU 使用率查看

```bash
# 实时查看 CPU 使用率
top

# 查看进程 CPU 使用排序
ps aux --sort=-%cpu | head -10

# 查看每个 CPU 核心的使用情况
mpstat -P ALL 1
```

### 2. 进程管理

```bash
# 查看进程详细信息
ps -ef | grep php-fpm

# 查看进程打开的文件
lsof -p <PID>

# 查看进程调用栈
pstack <PID>

# 终止进程
kill -9 <PID>

# 终止所有同名进程
pkill -f php-fpm
```

### 3. 日志分析

```bash
# 查看访问日志
tail -n 100 /var/log/nginx/access.log

# 查看错误日志
tail -n 100 /var/log/php-fpm/error.log

# 查看慢查询日志
tail -n 100 /var/log/mysql/mysql-slow.log
```

### 4. 网络限制

```bash
# 查看 iptables 规则
iptables -L -n

# 添加 IP 限制
iptables -A INPUT -s <IP> -j DROP

# 删除 IP 限制
iptables -D INPUT -s <IP> -j DROP
```

## 总结

本案例中，生产服务器 CPU 100% 告警的根本原因是异常请求导致的资源耗尽。客户端发起了大量包含 `limit=100000` 参数的请求，导致 PHP 进程需要处理大量数据，消耗大量 CPU 资源。

通过临时限制请求、清理异常进程等紧急措施，以及优化 API 接口、数据库查询和配置等根本解决方案，成功解决了故障。同时，通过添加请求限制、优化监控、代码优化等预防措施，避免类似故障再次发生。

此案例提醒我们，在开发和运维过程中，需要重视 API 接口的安全性和性能，对用户输入进行严格验证，避免因异常请求导致的资源耗尽问题。